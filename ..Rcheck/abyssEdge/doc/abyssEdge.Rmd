---
title: "abyssEdge: Tsallis entropy workflow"
author: "abyssEdge developers"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    fig_width: 8
    fig_height: 6 
vignette: >
  %\VignetteIndexEntry{abyssEdge}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Overview

This vignette demonstrates the current abyssEdge functionality: computing
Tsallis entropy across transcript-level expression data, performing gene-level
linear-model interaction testing across q values, and generating diagnostic
plots. The package focuses only on Tsallis entropy and basic differential
analyses.

## Example dataset

An example dataset is included for demonstration. Load the package and data:

```{r setup}
library(abyssEdge)
library(SummarizedExperiment)

# Prefer using extdata TSVs if present, otherwise fall back to bundled RData or synthetic data.
gene_tsv <- system.file("extdata", "tcga_gene_ids.tsv", package = "abyssEdge")
sample_tsv <- system.file("extdata", "tcga_sample_ids.tsv", package = "abyssEdge")
coldata_tsv <- system.file("extdata", "coldata.tsv", package = "abyssEdge")

## Prefer extdata coldata (sample IDs + Condition) when available.
if (file.exists(gene_tsv) && file.exists(coldata_tsv)) {
  gene_ids <- read.table(gene_tsv, header = FALSE, stringsAsFactors = FALSE)[, 1]
  cd <- read.table(coldata_tsv, header = TRUE, sep = "\t", stringsAsFactors = FALSE, check.names = FALSE)
  sample_ids <- as.character(cd[[1]])
  n_genes <- length(gene_ids)
  n_samples <- length(sample_ids)
  set.seed(2026)
  readcounts <- matrix(nrow = n_genes, ncol = n_samples)
  colnames(readcounts) <- sample_ids
  for (i in seq_len(n_genes)) {
    base <- round(runif(1, 5, 200))
    lambdas <- ifelse(grepl("_N$", sample_ids), base, pmax(1, round(base * runif(1, 1.05, 1.5))))
    readcounts[i, ] <- rpois(n_samples, lambda = lambdas)
  }
  genes <- gene_ids
} else if (file.exists(gene_tsv) && file.exists(sample_tsv)) {
  gene_ids <- read.table(gene_tsv, header = FALSE, stringsAsFactors = FALSE)[, 1]
  sample_ids <- read.table(sample_tsv, header = FALSE, stringsAsFactors = FALSE)[, 1]
  n_genes <- length(gene_ids)
  n_samples <- length(sample_ids)
  set.seed(2026)
  readcounts <- matrix(nrow = n_genes, ncol = n_samples)
  colnames(readcounts) <- sample_ids
  for (i in seq_len(n_genes)) {
    base <- round(runif(1, 5, 200))
    lambdas <- ifelse(grepl("_N$", sample_ids), base, pmax(1, round(base * runif(1, 1.05, 1.5))))
    readcounts[i, ] <- rpois(n_samples, lambda = lambdas)
  }
  genes <- gene_ids
} else {
  stop("Required extdata files not found. Please add 'tcga_gene_ids.tsv' and 'coldata.tsv' (or 'tcga_sample_ids.tsv') to inst/extdata before building vignettes.")
}

# Ensure we have at least two sample groups for the vignette examples; error if not.
sample_names <- colnames(readcounts)
groups <- if (!is.null(sample_names)) {
  ifelse(grepl("_N$", sample_names), "Normal",
         ifelse(grepl("_T$", sample_names) | grepl("_Tumor$", sample_names), "Tumor", NA))
} else {
  rep(NA_character_, ncol(readcounts))
}
if (length(unique(na.omit(groups))) < 2) {
  stop("Sample IDs in extdata do not define at least two sample groups (Normal/Tumor). Ensure sample IDs contain suffixes like '_N' and '_T'.")
}
```

# Calculate Tsallis entropy

Compute Tsallis entropy for a vector of q values (here we show an example
with two q values for speed):

```{r tsallis-calc}
# compute Tsallis entropy for q = 0.01 and q = 2 (normalized)
qvec <- c(0.01, 2)
ts_se <- calculate_diversity(readcounts, genes, method = "tsallis", q = qvec, norm = TRUE)
assay(ts_se)[1:5, ]
```

# Differential analysis (per-gene means + Wilcoxon)

Convert the `SummarizedExperiment` result to a data.frame expected by
`calculate_difference()` and run a simple comparison between sample types.

```{r difference}
# create a sample grouping vector inferred from sample names
# account for per-q column names like 'Sample_q=0.01' by stripping the '_q=...' suffix
sample_base_names <- sub("_q=.*", "", colnames(assay(ts_se)))
samples <- ifelse(grepl("_N$", sample_base_names), "Normal", "Tumor")

# prepare diversity table as data.frame with gene names in first column
div_df <- as.data.frame(assay(ts_se))
div_df <- cbind(genes = rowData(ts_se)$genes, div_df)

# run difference analysis (mean + wilcoxon)
res <- calculate_difference(div_df, samples, control = "Normal", method = "mean", test = "wilcoxon")
head(res)
```

# Linear-model interaction across q values

Use the per-gene linear-model interaction test implemented in
`calculate_lm_interaction()` to test whether the relationship between Tsallis
entropy and q differs between groups.

```{r lm-interaction}
# ensure the SummarizedExperiment contains sample names with group suffixes
# (the function infers group from sample name suffix _N -> Normal)
lm_res <- calculate_lm_interaction(ts_se, sample_type_col = NULL, min_obs = 8)
head(lm_res)
```

# Plots

Use the provided plotting helpers to visualize diversity distributions and the
Tsallis q-curve summary.

```{r plots, fig.width=6, fig.height=4}
# density plot of diversity values
p1 <- plot_diversity_density(ts_se, assay_name = "diversity")
print(p1)

# violin of per-gene means
p2 <- plot_mean_violin(ts_se, assay_name = "diversity")
print(p2)

# q-curve: median Â± IQR across q values by group
p3 <- plot_tsallis_q_curve(readcounts, genes, q_values = c(0.01, 0.1, 0.5, 2))
print(p3)
```

# Session info

```{r}
sessionInfo()
```
