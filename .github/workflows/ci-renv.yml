name: R-CMD-check with renv

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
      - name: Restore renv or install deps
        run: |
          Rscript -e 'if (file.exists("renv.lock")) { if(!requireNamespace("renv", quietly=TRUE)) install.packages("renv"); renv::restore() } else { if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes"); remotes::install_deps(dependencies = TRUE) }'
      - name: Style check (styler)
        run: |
          # Ensure styler and roxygen2 are available so styling of roxygen blocks succeeds
          Rscript -e 'if (!requireNamespace("styler", quietly=TRUE)) install.packages("styler"); if (!requireNamespace("roxygen2", quietly=TRUE)) install.packages("roxygen2")'
          Rscript scripts/check_style.R
      - name: Build package and run R CMD check
        env:
          _R_CHECK_CRAN_INCOMING_: FALSE
        run: |
          # Ensure devtools and roxygen are available and install common tooling
          Rscript -e 'install.packages(c("devtools","roxygen2","usethis","pkgdown","rcmdcheck","rversions","urlchecker"), repos = "https://cloud.r-project.org")'
          # Generate documentation if needed
          Rscript -e 'devtools::document(roclets = c("rd"))'
          # Build package tarball
          R CMD build --no-build-vignettes .
          PKG=$(ls -1t *.tar.gz | head -n1)
          # Run check without manual (faster) and no vignettes
          R CMD check --no-manual --no-vignettes --as-cran "$PKG"
