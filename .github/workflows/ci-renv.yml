name: R-CMD-check with renv

on:
  # Disabled automatic push/PR triggers because CircleCI is the canonical CI for `stable`.
  # Keep this workflow available for manual runs if needed.
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.5'
      - name: Cache renv library
        uses: actions/cache@v3
        with:
          path: renv/library
          key: ${{ runner.os }}-renv-R4.5-${{ hashFiles('renv.lock') }}
          restore-keys: ${{ runner.os }}-renv-R4.5-
      - name: Restore renv or install deps (including Suggests)
        run: |
          Rscript -e 'if (file.exists("renv.lock")) { if(!requireNamespace("renv", quietly=TRUE)) install.packages("renv", repos="https://cloud.r-project.org"); renv::restore() } else { if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes", repos="https://cloud.r-project.org"); remotes::install_deps(dependencies = c("Depends","Imports","LinkingTo","Suggests")) }'
      - name: Style check (styler)
        run: |
          Rscript -e 'if (!requireNamespace("styler", quietly=TRUE)) install.packages("styler", repos="https://cloud.r-project.org")'
          # Run linters and style checks from tools/
          Rscript tools/run_linters.R
      - name: Build package and run R CMD check
        env:
          _R_CHECK_CRAN_INCOMING_: FALSE
        run: |
          # Ensure minimal tooling is available (avoid installing Suggests like pkgdown/usethis)
          Rscript -e 'if (!requireNamespace("roxygen2", quietly=TRUE)) install.packages("roxygen2", repos = "https://cloud.r-project.org")'
          # Generate documentation if needed using roxygen2 only
          Rscript -e 'roxygen2::roxygenize()'
          # Build package tarball
          R CMD build --no-build-vignettes .
          PKG=$(ls -1t *.tar.gz | head -n1)
          # Run check without manual (faster) and no vignettes
          R CMD check --no-manual --no-vignettes --as-cran "$PKG"
