name: R-CMD-check with renv

on:
  push:
    branches: [ stable ]
  pull_request:
    branches: [ stable ]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
      - name: Restore renv or install deps
        run: |
          Rscript -e 'if (file.exists("renv.lock")) { if(!requireNamespace("renv", quietly=TRUE)) install.packages("renv"); renv::restore() } else { if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes"); remotes::install_deps(dependencies = c("Depends","Imports","LinkingTo")) }'
      - name: Style check (styler)
        run: |
          Rscript -e 'if (!requireNamespace("styler", quietly=TRUE)) install.packages("styler");'
          Rscript scripts/check_style.R
      - name: Build package and run R CMD check
        env:
          _R_CHECK_CRAN_INCOMING_: FALSE
        run: |
          # Ensure minimal tooling is available (avoid installing Suggests like pkgdown/usethis)
          Rscript -e 'if (!requireNamespace("roxygen2", quietly=TRUE)) install.packages("roxygen2", repos = "https://cloud.r-project.org")'
          # Generate documentation if needed using roxygen2 only
          Rscript -e 'roxygen2::roxygenize()'
          # Build package tarball
          R CMD build --no-build-vignettes .
          PKG=$(ls -1t *.tar.gz | head -n1)
          # Run check without manual (faster) and no vignettes
          R CMD check --no-manual --no-vignettes --as-cran "$PKG"
