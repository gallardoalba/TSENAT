version: 2.1

jobs:
  build:
    docker:
      - image: rocker/r-ver:4.5.0
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Setup R library paths
          command: |
            mkdir -p ~/R/library
            echo 'R_LIBS_USER="~/R/library"' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Install OS dependencies
          command: |
            apt-get update && apt-get install -y --no-install-recommends \
              build-essential gfortran liblapack-dev libblas-dev \
              libxml2-dev libssl-dev libcurl4-openssl-dev libgit2-dev \
              pandoc openssh-client git
            rm -rf /var/lib/apt/lists/*
      - restore_cache:
          keys:
            - v1-r-packages-{{ checksum "DESCRIPTION" }}-r4.5.0
      - run:
          name: Install package dependencies
          command: |
            R -e 'install.packages(c("remotes", "devtools", "rcmdcheck", "ggplot2", "magrittr", "tidyr", "dplyr", "knitr", "rmarkdown", "xml2", "ggrepel", "cowplot", "patchwork", "mgcv", "pkgdown", "lme4", "lmerTest", "covr"), repos="https://cloud.r-project.org")'
            R -e 'if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager", repos="https://cloud.r-project.org"); BiocManager::install(c("SummarizedExperiment", "S4Vectors"), ask=FALSE)'
      - save_cache:
          paths:
            - ~/R/library
          key: v1-r-packages-{{ checksum "DESCRIPTION" }}-r4.5.0
      - run:
          name: Build package
          command: |
            R CMD build .
      - run:
          name: Install R package dependencies (including Suggests)
          command: |
            R -e 'if (!requireNamespace("remotes", quietly=TRUE)) install.packages("remotes", repos="https://cloud.r-project.org"); remotes::install_deps(dependencies = TRUE)'
      - run:
          name: Fetch tools and CI config from maintenance branch
          command: |
            set -euxo pipefail
            ORIG_URL=$(git remote get-url origin)
            if command -v ssh >/dev/null 2>&1; then
              git fetch origin maintenance || true
              git checkout origin/maintenance -- tools || true
              git checkout origin/maintenance -- .codecov.yml || true
            else
              # Convert SSH-style remote URL to HTTPS if needed
              if echo "$ORIG_URL" | grep -qE '^(git@|ssh://)'; then
                HTTPS_URL=$(echo "$ORIG_URL" | sed -E 's#^(git@|ssh://)([^:/]+)[:/](.+)$#https://\2/\3#')
              else
                HTTPS_URL="$ORIG_URL"
              fi
              # Fetch the maintenance branch from the HTTPS URL into origin/maintenance
              git fetch "$HTTPS_URL" maintenance:refs/remotes/origin/maintenance || true
              git checkout origin/maintenance -- tools || true
              git checkout origin/maintenance -- .codecov.yml || true
            fi
            chmod +x tools/*.sh || true
            find tools -type f -name '*.R' -exec chmod +x {} \; || true
      - run:
          name: Check code style with styler
          command: |
            R -e 'if (!requireNamespace("styler", quietly=TRUE)) install.packages("styler", repos="https://cloud.r-project.org")'
            Rscript tools/apply_style.R || true
      - run:
          name: Run checks
          command: |
            export _R_CHECK_FORCE_SUGGESTS_=false
            R CMD check --no-manual *.tar.gz

      - run:
          name: Generate coverage and HTML report
          command: |
            Rscript tools/run_coverage.R
      - store_artifacts:
          path: coverage
          destination: coverage
      - run:
          name: Upload coverage to Codecov
          command: |
            Rscript tools/run_coverage.R --upload

workflows:
  version: 2
  build_and_upload:
    jobs:
      - build:
          filters:
            branches:
              only:
                - stable
                - main
                - master
