version: 2.1

jobs:
  build:
    docker:
      - image: rocker/r-ver:4.5.2
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-os-deps-{{ .Branch }}
            - v1-os-deps-
      - run:
          name: Install OS dependencies (cached)
          command: |
            apt-get update && apt-get install -y --no-install-recommends \
              build-essential gfortran liblapack-dev libblas-dev \
              libxml2-dev libssl-dev libcurl4-openssl-dev libgit2-dev \
              pandoc openssh-client git \
              libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev \
              fontconfig libfontconfig1-dev pkg-config
            rm -rf /var/lib/apt/lists/*
      - save_cache:
          paths:
            - /var/cache/apt
          key: v1-os-deps-{{ .Branch }}
      - restore_cache:
          keys:
            - v1-r-packages-{{ checksum "DESCRIPTION" }}-r4.5.2
      - run:
          name: Install package dependencies
          command: |
            Rscript - \<<'EOF'
            options(Ncpus = 4)
            if (!requireNamespace("BiocManager", quietly = TRUE)) {
              install.packages("BiocManager", repos = "https://cloud.r-project.org")
            }
            cran_pkgs <- c("remotes", "rcmdcheck", "covr")
            install.packages(cran_pkgs, repos = "https://cloud.r-project.org")
            remotes::install_deps(dependencies = TRUE, upgrade = "never")
            EOF
      - save_cache:
          paths:
            - /usr/local/lib/R/site-library
          key: v1-r-packages-{{ checksum "DESCRIPTION" }}-r4.5.2
      - run:
          name: Build package
          command: |
            R CMD build .
      - run:
          name: Fetch tools and CI config from maintenance branch
          command: |
            set -euxo pipefail
            ORIG_URL=$(git remote get-url origin)
            if command -v ssh >/dev/null 2>&1; then
              git fetch origin maintenance || true
              git checkout origin/maintenance -- tools || true
              git checkout origin/maintenance -- .codecov.yml || true
            else
              # Convert SSH-style remote URL to HTTPS if needed
              if echo "$ORIG_URL" | grep -qE '^(git@|ssh://)'; then
                HTTPS_URL=$(echo "$ORIG_URL" | sed -E 's#^(git@|ssh://)([^:/]+)[:/](.+)$#https://\2/\3#')
              else
                HTTPS_URL="$ORIG_URL"
              fi
              # Fetch the maintenance branch from the HTTPS URL into origin/maintenance
              git fetch "$HTTPS_URL" maintenance:refs/remotes/origin/maintenance || true
              git checkout origin/maintenance -- tools || true
              git checkout origin/maintenance -- .codecov.yml || true
            fi
            chmod +x tools/*.sh || true
            find tools -type f -name '*.R' -exec chmod +x {} \; || true
      - run:
          name: Apply code formatting (if available)
          command: |
            if [ -f tools/apply_formatR.R ]; then
              echo "Running code style formatter..."
              Rscript tools/apply_formatR.R || echo "Warning: Code formatting script failed"
            else
              echo "Skipping code formatting (tools/apply_formatR.R not found)"
            fi
      - run:
          name: Run checks with parallel compilation
          command: |
            export _R_CHECK_FORCE_SUGGESTS_=false
            R CMD check --no-manual --num-workers=auto *.tar.gz
      - run:
          name: Generate coverage report and upload
          command: |
            if [ -f tools/run_coverage.R ]; then
              Rscript tools/run_coverage.R
              # Upload coverage in same step
              if [ -f coverage/coverage.html ]; then
                timeout 30 bash -c 'curl -s https://codecov.io/bash | bash' || echo "Warning: Codecov upload failed"
              fi
            else
              echo "Warning: tools/run_coverage.R not found"
            fi

workflows:
  version: 2
  build_and_upload:
    jobs:
      - build
